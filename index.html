<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ ìƒì‹ í€´ì¦ˆ</title>
    <style>
        /* CSS ì‹œì‘ */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        h1 {
            color: #4a90e2;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        #quiz-container {
            border-top: 2px solid #eee;
            padding-top: 20px;
            min-height: 250px;
            text-align: left;
        }
        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .choices button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .choices button:hover:not(:disabled) {
            background-color: #e6f7ff;
            border-color: #4a90e2;
        }
        .choices button.correct {
            background-color: #d4edda;
            border-color: #28a745;
            font-weight: bold;
        }
        .choices button.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            font-weight: bold;
        }
        #explanation-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-left: 5px solid #4a90e2;
            font-size: 0.95em;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }
        #result-message {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }
        #nav-buttons button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #nav-buttons .start-quiz {
            background-color: #4a90e2;
            color: white;
        }
        #nav-buttons .review-mode {
            background-color: #f5a623;
            color: white;
        }
        /* ë³µìŠµ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        #review-list {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }
        .review-item {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: left;
        }
        .review-item p {
            margin: 5px 0;
        }
        .review-item .question-text {
            color: #856404;
            font-size: 1.1em;
        }
        .review-item .correct-answer {
            color: #007bff;
            font-weight: bold;
        }
        .review-item .review-explanation {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ffeeba;
            color: #555;
            font-size: 0.9em;
        }
        /* CSS ë */
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">ì˜¤ëŠ˜ì˜ ìƒì‹ í€´ì¦ˆ</h1>
        
        <div id="loading" style="display: none; color: #4a90e2;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        
        <div id="quiz-container">
            </div>

        <div id="nav-buttons">
            <button class="start-quiz" onclick="loadQuizData()">í€´ì¦ˆ ì‹œì‘</button>
            <button class="review-mode" onclick="showReviewMode()">ë³µìŠµ ëª¨ë“œ</button>
        </div>
    </div>

    <script>
        // JavaScript ì‹œì‘
        
        // ğŸ’¡ BASE_URLì„ ì œê±°í•˜ê³  ìƒëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. 
        // Vercelì´ index.htmlì„ ì„œë¹™í•˜ë¯€ë¡œ, API ìš”ì²­ì€ ìë™ìœ¼ë¡œ ê°™ì€ ë„ë©”ì¸ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
        const QUIZ_API_URL = '/api/quiz';
        const ANSWER_KEY_API_URL = '/api/answer-key'; 

        const STORAGE_KEY = 'wrong_answers'; 

        let currentQuizData = []; 
        let correctAnswerMap = {}; 
        let currentQuestionIndex = 0;
        let score = 0;

        const quizContainer = document.getElementById('quiz-container');
        const navButtons = document.getElementById('nav-buttons');
        const loadingDiv = document.getElementById('loading');
        const pageTitle = document.getElementById('page-title');

        // ==========================================================
        // Local Storage ê´€ë¦¬ í•¨ìˆ˜
        // ==========================================================
        
        function getWrongAnswers() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        /** ì˜¤ë‹µì„ Local Storageì— ì¶”ê°€í•©ë‹ˆë‹¤. (í•´ì„¤, ì‹¤ì œ ì •ë‹µ ì¸ë±ìŠ¤ í¬í•¨) */
        function addWrongAnswer(questionData, selectedIndex, actualCorrectIndex) {
            const wrongAnswers = getWrongAnswers();
            
            const newWrongAnswer = {
                question: questionData.question,
                choices: questionData.choices,
                explanation: questionData.explanation, 
                correctAnswerIndex: actualCorrectIndex, // ğŸ’¡ ì‹¤ì œ ì •ë‹µ ì¸ë±ìŠ¤ ì €ì¥
                userAnswerIndex: selectedIndex,
                savedTime: new Date().toLocaleString()
            };

            const isDuplicate = wrongAnswers.some(item => item.question === newWrongAnswer.question);
            if (!isDuplicate) {
                wrongAnswers.push(newWrongAnswer);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(wrongAnswers));
            }
        }

        function clearWrongAnswers() {
            localStorage.removeItem(STORAGE_KEY);
            alert('ë³µìŠµ ë¬¸ì œê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            showReviewMode(); 
        }

        // ==========================================================
        // ë©”ì¸ í€´ì¦ˆ ëª¨ë“œ ë¡œì§
        // ==========================================================

        /** í€´ì¦ˆ ë°ì´í„°ì™€ ì •ë‹µ í‚¤ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ ë§¤ì¹­í•©ë‹ˆë‹¤. */
        async function loadQuizData() {
            pageTitle.textContent = 'ì˜¤ëŠ˜ì˜ ìƒì‹ í€´ì¦ˆ';
            quizContainer.innerHTML = '';
            navButtons.innerHTML = '';
            loadingDiv.style.display = 'block';

            try {
                // 1. í€´ì¦ˆ ì§ˆë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©)
                const quizResponse = await fetch(QUIZ_API_URL);
                if (!quizResponse.ok) throw new Error(`Quiz data failed: ${quizResponse.status}`);
                currentQuizData = await quizResponse.json();
                
                // 2. í€´ì¦ˆ ì •ë‹µ í‚¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©)
                const answerResponse = await fetch(ANSWER_KEY_API_URL);
                if (!answerResponse.ok) throw new Error(`Answer key failed: ${answerResponse.status}`);
                correctAnswerMap = await answerResponse.json(); 

                // 3. í€´ì¦ˆ ë°ì´í„°ì— ì •ë‹µ ì¸ë±ìŠ¤ ë§¤ì¹­
                currentQuizData = currentQuizData.map(q => {
                    const id = q.id;
                    return {
                        ...q,
                        correctAnswerIndex: correctAnswerMap[id] 
                    };
                });
                
                // 4. ë¡œë”© ì™„ë£Œ ë° í‘œì‹œ
                currentQuestionIndex = 0;
                score = 0;
                loadingDiv.style.display = 'none';
                displayQuestion();

            } catch (error) {
                loadingDiv.style.display = 'none';
                // ğŸ’¡ ì„œë²„ê°€ Vercelì—ì„œ ì‘ë™í•˜ê³  ìˆìœ¼ë¯€ë¡œ ë¡œì»¬ ì„œë²„ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
                quizContainer.innerHTML = `<p style="color: red;">í€´ì¦ˆ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. Vercel ì„œë²„ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                showHomeButtons();
            }
        }

        /** í˜„ì¬ ì§ˆë¬¸ì„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuizData.length) {
                showResults();
                return;
            }

            const question = currentQuizData[currentQuestionIndex];
            
            if (typeof question.correctAnswerIndex === 'undefined') {
                quizContainer.innerHTML = `<p style="color: red;">[ì˜¤ë¥˜] ì •ë‹µ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>`;
                return;
            }
            
            let choicesHtml = question.choices.map((choice, index) => `
                <button onclick="checkAnswer(${index})">${choice}</button>
            `).join('');

            quizContainer.innerHTML = `
                <p class="question-text">(${currentQuestionIndex + 1}/${currentQuizData.length}) ${question.question}</p>
                <div class="choices" id="choices-container">
                    ${choicesHtml}
                </div>
                <div id="feedback" style="margin-top: 15px;"></div>
                <div id="explanation-box" style="display: none;">
                    <strong>í•´ì„¤:</strong> <span id="explanation-text">${question.explanation || 'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</span>
                </div>
            `;
            navButtons.innerHTML = ''; 
        }

        /** ì‚¬ìš©ìì˜ ë‹µë³€ì„ í™•ì¸í•˜ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤. */
        function checkAnswer(selectedIndex) {
            const question = currentQuizData[currentQuestionIndex];
            const actualCorrectIndex = question.correctAnswerIndex; 
            const isCorrect = (selectedIndex === actualCorrectIndex);
            
            const choicesContainer = document.getElementById('choices-container');
            const feedbackDiv = document.getElementById('feedback');
            const explanationBox = document.getElementById('explanation-box'); 
            
            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì •/ì˜¤ë‹µ í‘œì‹œ
            Array.from(choicesContainer.children).forEach((button, index) => {
                button.disabled = true;
                if (index === actualCorrectIndex) {
                    button.classList.add('correct'); 
                }
                if (index === selectedIndex && !isCorrect) {
                    button.classList.add('incorrect'); 
                }
            });

            if (isCorrect) {
                score++;
                feedbackDiv.innerHTML = '<span style="color: green;">âœ… ì •ë‹µì…ë‹ˆë‹¤!</span>';
            } else {
                feedbackDiv.innerHTML = '<span style="color: red;">âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.</span>';
                // ğŸ’¡ ì˜¤ë‹µ ì‹œ Local Storageì— ì €ì¥
                addWrongAnswer(question, selectedIndex, actualCorrectIndex);
            }

            // ì •ë‹µ/ì˜¤ë‹µ í™•ì¸ í›„ í•´ì„¤ í‘œì‹œ
            explanationBox.style.display = 'block';

            // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼
            navButtons.innerHTML = `<button onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ (${currentQuestionIndex + 1}/${currentQuizData.length})</button>`;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function showResults() {
            quizContainer.innerHTML = `
                <h2>í€´ì¦ˆ ì¢…ë£Œ!</h2>
                <p id="result-message">ìµœì¢… ì ìˆ˜: ${score} / ${currentQuizData.length}</p>
                <p>í‹€ë¦° ë¬¸ì œëŠ” ë³µìŠµ ëª¨ë“œì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”! ğŸ’ª</p>
            `;
            showHomeButtons();
        }

        // ==========================================================
        // ë³µìŠµ ëª¨ë“œ ë¡œì§ (í•´ì„¤ í¬í•¨, ì •í™•í•œ ì •ë‹µ í‘œì‹œ)
        // ==========================================================

        function showReviewMode() {
            pageTitle.textContent = 'ğŸ“ ì˜¤ë‹µ ë³µìŠµ ëª¨ë“œ';
            navButtons.innerHTML = '';
            
            const wrongAnswers = getWrongAnswers();
            
            if (wrongAnswers.length === 0) {
                quizContainer.innerHTML = `<p>í˜„ì¬ ì €ì¥ëœ ì˜¤ë‹µ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í€´ì¦ˆì—ì„œ ë¬¸ì œë¥¼ í‹€ë¦¬ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤!</p>`;
            } else {
                let reviewListHtml = wrongAnswers.map(item => {
                    const correctAnswerText = item.choices[item.correctAnswerIndex];
                    const userAnswerText = item.choices[item.userAnswerIndex];

                    return `
                        <li class="review-item">
                            <p class="question-text">Q: ${item.question}</p>
                            <p>ì„ íƒí–ˆë˜ ì˜¤ë‹µ: <span style="color: #dc3545;">${userAnswerText}</span></p>
                            <p class="correct-answer">ì •ë‹µ: ${correctAnswerText}</p>
                            <p class="review-explanation">í•´ì„¤: ${item.explanation || 'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                            <p style="font-size: 0.9em; color: #6c757d;">(ì €ì¥ ì‹œê°„: ${item.savedTime})</p>
                        </li>
                    `;
                }).join('');

                quizContainer.innerHTML = `
                    <h2>ì´ ${wrongAnswers.length}ê°œì˜ ë³µìŠµ ë¬¸ì œ</h2>
                    <ul id="review-list">
                        ${reviewListHtml}
                    </ul>
                    <button onclick="clearWrongAnswers()" style="background-color: #dc3545; color: white;">ë³µìŠµ ë¬¸ì œ ì „ì²´ ì‚­ì œ</button>
                `;
            }
            showHomeButtons();
        }

        // ==========================================================
        // ê³µí†µ UI/ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        // ==========================================================

        function showHomeButtons() {
             navButtons.innerHTML = `
                <button class="start-quiz" onclick="loadQuizData()">í€´ì¦ˆ ë‹¤ì‹œ ì‹œì‘</button>
                <button class="review-mode" onclick="showReviewMode()">ë³µìŠµ ëª¨ë“œ (${getWrongAnswers().length})</button>
             `;
        }
        
        showHomeButtons(); 
        // ğŸ’¡ Vercel ë°°í¬ í›„ì—ëŠ” ë¡œì»¬ ì„œë²„ ì•ˆë‚´ ë¬¸êµ¬ ì œê±°
        quizContainer.innerHTML = '<p>ìƒì‹ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ "í€´ì¦ˆ ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”. ì„œë²„ê°€ Vercelì— ì •ìƒ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.ğŸš€</p>';

        // JavaScript ë
    </script>
</body>
</html>